---
- hosts:
    - ffp_gw

  collections:
    - devsec.hardening
    - freifunk_potsdam.gluon

  roles:
    - weareinteractive.users
    - Frzk.nftables
    - stuvusit.systemd-journald
    - hafu.systemd_timesyncd
    - ssh_hardening
    # collection: freifunk_potsdam.gluon
    - system_packages
    - default_network
    - policy_routing
    - tunneldigger_client
    - batman_adv
    - gw2gw_l2tp
    - fastd_server
    - isc_dhcp_server
    - bind_server

  pre_tasks:

    - name: Allow users in group sudo to switch without password
      ansible.builtin.lineinfile:
        path: /etc/sudoers
        state: present
        regexp: '^%sudo\sALL='
        line: '%sudo ALL=(ALL) NOPASSWD: ALL'
        validate: /usr/sbin/visudo -cf %s

    - name: Remove WireGuard network configuration
      ansible.builtin.file:
        path: "/etc/systemd/network/60-ffupwg.{{ item }}"
        state: absent
      loop:
        - "netdev"
        - "network"
      notify:
        - "Reload systemd daemon"
        - "Restart systemd-networkd"

  tasks: []

  handlers:
    - name: "Reload systemd daemon"
      ansible.builtin.systemd:
        daemon_reload: true

    - name: "Restart systemd-networkd"
      ansible.builtin.systemd:
        service: systemd-networkd
        state: restarted
